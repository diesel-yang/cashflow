<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#208b8c">
  <title>極速記帳 v3.3（餐廳＋個人 JACK/WAL）</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="styles.css">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
  <div id="app">
    <header class="app-bar">
      <div class="title">極速記帳 v3.3（餐廳＋個人 JACK/WAL）</div>
      <div class="month-switcher">
        <button @click="prevMonth">‹</button>
        <span>{{ currentMonthLabel }}</span>
        <button @click="nextMonth">›</button>
      </div>
    </header>

    <main>
      <!-- 記帳 -->
      <section v-if="tab==='input'" class="card">
        <div class="mode-row">
          <select v-model="mode" class="select">
            <option value="restaurant">餐廳</option>
            <option value="personal-JACK">JACK</option>
            <option value="personal-WAL">WAL</option>
          </select>
          <select v-model="payAccount" class="select">
            <option>現金</option><option>銀行</option><option>信用卡</option><option>電子支付</option>
            <option>JACK先墊</option><option>WAL先墊</option>
          </select>
          <label class="switch"><input type="checkbox" v-model="isReimburse"> 報銷</label>
        </div>

        <div class="amount-input">
          <div class="toggle">
            <button :class="{active:type==='expense'}" @click="type='expense'">支出</button>
            <button :class="{active:type==='income'}" @click="type='income'">收入</button>
          </div>
          <input inputmode="decimal" v-model="amountStr" placeholder="金額" @focus="$event.target.select()">
        </div>

        <div class="category-grid">
          <button v-for="c in categories" :key="c" :class="['chip', c===category?'chip-active':'']" @click="category=c">{{ c }}</button>
        </div>

        <div class="note-row">
          <input v-model="vendor" placeholder="商家/店名（自動分類）" @change="applyVendorRule">
          <input v-model="note" placeholder="備註（選填）">
          <input type="date" v-model="date">
        </div>

        <div class="note-row">
          <input type="file" accept="image/*" capture="environment" @change="onReceipt" />
          <span class="hint" v-if="hasReceipt">已附憑證 ✅</span>
        </div>

        <div class="quick-row">
          <span class="hint">快捷：</span>
          <button class="quick" v-for="q in quicks" :key="q.label" @click="applyQuick(q)">{{ q.label }}</button>
        </div>

        <button class="primary" @click="save">記錄</button>
      </section>

      <!-- 轉帳 -->
      <section v-else-if="tab==='transfer'" class="card">
        <h3>轉帳 / 還款</h3>
        <div class="mode-row">
          <select v-model="fromAccount" class="select">
            <option value="餐廳_現金">餐廳_現金</option><option value="餐廳_銀行">餐廳_銀行</option>
            <option value="JACK">JACK</option><option value="WAL">WAL</option>
          </select>
          <span>→</span>
          <select v-model="toAccount" class="select">
            <option value="餐廳_現金">餐廳_現金</option><option value="餐廳_銀行">餐廳_銀行</option>
            <option value="JACK">JACK</option><option value="WAL">WAL</option>
          </select>
        </div>
        <div class="amount-input">
          <input inputmode="decimal" v-model="transferAmountStr" placeholder="金額">
          <input type="date" v-model="transferDate">
        </div>
        <input class="input" v-model="transferNote" placeholder="備註（選填）">
        <button class="primary" @click="saveTransfer">建立轉帳並自動沖銷報銷</button>

        <div class="dues" style="margin-top:12px">
          <div class="due-card"><div class="label">目前應付 JACK</div><div class="value" :class="{neg: dueJACK>0}">{{ dueJACK.toLocaleString() }}</div></div>
          <div class="due-card"><div class="label">目前應付 WAL</div><div class="value" :class="{neg: dueWAL>0}">{{ dueWAL.toLocaleString() }}</div></div>
        </div>
      </section>

      <!-- 報表 -->
      <section v-else-if="tab==='report'" class="card">
        <div class="filters">
          <select v-model="filterEntity" class="select small">
            <option value="all">全部</option><option value="restaurant">僅餐廳</option><option value="personal">僅個人</option>
          </select>
          <select v-model="filterPerson" class="select small" :disabled="filterEntity!=='personal'">
            <option value="all">JACK+WAL</option><option value="JACK">JACK</option><option value="WAL">WAL</option>
          </select>
          <label class="switch small"><input type="checkbox" v-model="netTransfers"> 淨額化互轉/報銷</label>
          <button class="mini" @click="exportCSV('month')">匯出本月 CSV</button>
          <button class="mini" @click="exportCSV('all')">匯出全部 CSV</button>
        </div>

        <div class="summary">
          <div class="summary-item"><div class="label">收入</div><div class="value">+{{ sumIncome.toLocaleString() }}</div></div>
          <div class="summary-item"><div class="label">支出</div><div class="value">-{{ sumExpense.toLocaleString() }}</div></div>
          <div class="summary-item"><div class="label">結餘</div><div class="value" :class="{neg: net<0}">{{ net.toLocaleString() }}</div></div>
        </div>

        <div class="dues">
          <div class="due-card"><div class="label">應付 JACK</div><div class="value" :class="{neg: dueJACK>0}">{{ dueJACK.toLocaleString() }}</div></div>
          <div class="due-card"><div class="label">應付 WAL</div><div class="value" :class="{neg: dueWAL>0}">{{ dueWAL.toLocaleString() }}</div></div>
        </div>

        <div v-if="filterEntity==='restaurant'">
          <h3>餐廳 P&L（本月）</h3>
          <div class="pl-grid">
            <div class="pl-row"><span>營業收入</span><b>{{ pl.revenue.toLocaleString() }}</b></div>
            <div class="pl-row"><span>銷貨成本（COGS）</span><b>-{{ pl.cogs.toLocaleString() }}</b></div>
            <div class="pl-row total"><span>毛利</span><b>{{ pl.grossProfit.toLocaleString() }}</b></div>
            <div class="pl-row"><span>人事費用</span><b>-{{ pl.personnel.toLocaleString() }}</b></div>
            <div class="pl-row"><span>場地水電</span><b>-{{ pl.utilities.toLocaleString() }}</b></div>
            <div class="pl-row"><span>行銷/平台</span><b>-{{ pl.marketing.toLocaleString() }}</b></div>
            <div class="pl-row"><span>物流交通</span><b>-{{ pl.logistics.toLocaleString() }}</b></div>
            <div class="pl-row"><span>行政/財務</span><b>-{{ pl.admin.toLocaleString() }}</b></div>
            <div class="pl-row"><span>其他</span><b>-{{ pl.other.toLocaleString() }}</b></div>
            <div class="pl-row total"><span>營業利益</span><b>{{ pl.operatingProfit.toLocaleString() }}</b></div>
          </div>
          <div class="kpis">
            <div class="kpi"><div class="kpi-label">COGS%</div><div class="kpi-value">{{ pl.cogsRate.toFixed(1) }}%</div></div>
            <div class="kpi"><div class="kpi-label">人事%</div><div class="kpi-value">{{ pl.personnelRate.toFixed(1) }}%</div></div>
          </div>
          <canvas id="plbar" height="220" style="margin:10px 0;"></canvas>
        </div>

        <canvas id="pie" height="220"></canvas>
        <canvas id="line" height="220" style="margin-top:16px;"></canvas>

        <div class="list">
          <div class="list-item header"><div>日期</div><div>分類</div><div>金額</div><div>備註/報銷</div></div>
          <div class="list-item" v-for="r in filteredMonthRecords" :key="r.id">
            <div>{{ r.date }}</div>
            <div>
              <span class="pill" :class="'pill-'+(r.entity||'')">{{ r.entity==='restaurant'?'餐廳':(r.person?('個人-'+r.person):'個人') }}</span>
              <span v-if="r.type==='transfer'" class="pill pill-transfer">轉帳</span>
              {{ r.category || (r.type==='transfer' ? (r.transfer.from + '→' + r.transfer.to) : '') }}
            </div>
            <div :class="r.type==='expense'?'neg':''">{{ r.type==='expense' ? '-' : (r.type==='income' ? '+' : '')}}{{ r.amount }}</div>
            <div class="note-ellipsis">
              {{ r.note || '' }}
              <template v-if="r.settlement && r.settlement.status!=='paid'">
                <span class="badge">先墊：{{ r.settlement.due_to }}（剩 {{ (r.settlement.remaining ?? r.amount).toLocaleString() }}）</span>
                <button class="mini" @click="settle(r)">結清</button>
              </template>
              <template v-if="r.receipt_id"><button class="mini" @click="viewReceipt(r)">憑證</button></template>
            </div>
          </div>
        </div>
      </section>

      <!-- 設定 -->
      <section v-else class="card">
        <h3>設定 / 匯入 / 同步</h3>
        <details open>
          <summary><b>分類管理</b>（可直接新增/刪除）</summary>
          <div class="settings-grid">
            <div>
              <h4>餐廳分類</h4>
              <div class="row">
                <input class="input small" v-model="newRestCat" placeholder="新分類（例：餐具耗材）">
                <select v-model="newRestGroup" class="select small">
                  <option value="cogs">COGS</option><option value="personnel">人事</option>
                  <option value="utilities">場地水電</option><option value="marketing">行銷平台</option>
                  <option value="logistics">物流交通</option><option value="admin">行政財務</option>
                  <option value="other">其他</option><option value="revenue">收入</option>
                </select>
                <button class="mini" @click="addRestaurantCat">新增</button>
              </div>
              <ul class="kv">
                <li v-for="c in settings.cats_restaurant" :key="c">
                  {{ c }} <small v-if="settings.plMap[c]">（{{ settings.plMap[c] }}）</small>
                  <button class="mini" @click="delRestaurantCat(c)">刪除</button>
                </li>
              </ul>
            </div>
            <div>
              <h4>個人分類（JACK/WAL 共用）</h4>
              <div class="row">
                <input class="input small" v-model="newPersonalCat" placeholder="新分類（例：寵物）">
                <button class="mini" @click="addPersonalCat">新增</button>
              </div>
              <ul class="kv">
                <li v-for="c in settings.cats_personal" :key="c">
                  {{ c }} <button class="mini" @click="delPersonalCat(c)">刪除</button>
                </li>
              </ul>
            </div>
          </div>
        </details>

        <details>
          <summary><b>預算設定</b>（近超支門檻：<input style="width:64px" v-model.number="settings.warnThreshold" type="number" min="0" max="1" step="0.05">）</summary>
          <div class="settings-grid">
            <div>
              <h4>餐廳預算</h4>
              <div class="row">
                <select v-model="budgetCatRestaurant" class="select small">
                  <option v-for="c in settings.cats_restaurant" :key="c" :value="c">{{ c }}</option>
                </select>
                <input class="input small" v-model.number="budgetAmtRestaurant" type="number" min="0" placeholder="金額">
                <button class="mini" @click="addBudget('restaurant')">新增/覆寫</button>
              </div>
              <ul class="kv">
                <li v-for="(amt,cat) in settings.budgets.restaurant" :key="cat">{{ cat }}：{{ amt }} <button class="mini" @click="delBudget('restaurant',cat)">刪除</button></li>
              </ul>
            </div>

            <div>
              <h4>JACK 預算</h4>
              <div class="row">
                <select v-model="budgetCatJ" class="select small">
                  <option v-for="c in settings.cats_personal" :key="c" :value="c">{{ c }}</option>
                </select>
                <input class="input small" v-model.number="budgetAmtJ" type="number" min="0" placeholder="金額">
                <button class="mini" @click="addBudget('JACK')">新增/覆寫</button>
              </div>
              <ul class="kv">
                <li v-for="(amt,cat) in settings.budgets.personal.JACK" :key="cat">{{ cat }}：{{ amt }} <button class="mini" @click="delBudget('JACK',cat)">刪除</button></li>
              </ul>
            </div>

            <div>
              <h4>WAL 預算</h4>
              <div class="row">
                <select v-model="budgetCatW" class="select small">
                  <option v-for="c in settings.cats_personal" :key="c" :value="c">{{ c }}</option>
                </select>
                <input class="input small" v-model.number="budgetAmtW" type="number" min="0" placeholder="金額">
                <button class="mini" @click="addBudget('WAL')">新增/覆寫</button>
              </div>
              <ul class="kv">
                <li v-for="(amt,cat) in settings.budgets.personal.WAL" :key="cat">{{ cat }}：{{ amt }} <button class="mini" @click="delBudget('WAL',cat)">刪除</button></li>
              </ul>
            </div>
          </div>
        </details>

        <details>
          <summary><b>CSV 匯入</b>（支援本系統匯出欄位）</summary>
          <input type="file" accept=".csv,text/csv" @change="importCSV">
          <p class="hint">合併策略：若 CSV 行含 id 並且本機同 id 已存在 → 以較新的日期覆寫；否则新增。</p>
        </details>

        <details>
          <summary><b>雲端同步（讀 GitHub Pages JSON）</b></summary>
          <div class="row">
            <input class="input" v-model="settings.remoteUrl" placeholder="遠端 JSON 位置（例：https://yourname.github.io/cashflow/data.json）">
          </div>
          <div class="row">
            <button class="mini" @click="pullRemote">從網址拉取 → 合併</button>
            <button class="mini" @click="pushRemote">產生 JSON 檔（下載）</button>
          </div>
          <p class="hint">說明：GitHub Pages 僅支援讀取；推送請把下載的 JSON 手動上傳/覆蓋到你的 repo。</p>
        </details>

        <div style="margin-top:10px">
          <button class="primary" @click="saveSettings">儲存設定</button>
        </div>
      </section>
    </main>

    <nav class="tabbar">
      <button :class="{active:tab==='input'}" @click="tab='input'">記帳</button>
      <button :class="{active:tab==='transfer'}" @click="tab='transfer'">轉帳</button>
      <button :class="{active:tab==='report'}" @click="tab='report'; $nextTick(drawCharts)">報表</button>
      <button :class="{active:tab==='settings'}" @click="tab='settings'">設定</button>
    </nav>

    <footer class="footer"><small>{{ version }}</small></footer>
  </div>

  <!-- libs -->
  <script defer src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
  <script>if(!window.Vue){var s=document.createElement('script');s.defer=true;s.src='https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js';document.head.appendChild(s);}</script>
  <script defer src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="app.js"></script>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js?v=13');
    });
  }
  </script>
</body>
</html>